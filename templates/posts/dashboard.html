{% extends 'base/base.html' %}

{% block title %}Tableau de bord - Linkedong{% endblock %}

{% block extra_css %}
<style>
    .dashboard-container {
        background-color: #f3f2ef;
        min-height: 100vh;
        padding: 2rem 0;
    }

    .sidebar {
        position: sticky;
        top: 2rem;
    }

    .profile-card {
        background: white;
        border-radius: 0.75rem;
        border: 1px solid #e0e0e0;
        overflow: hidden;
        margin-bottom: 1rem;
    }

    .profile-header {
        background: linear-gradient(135deg, var(--linkedin-blue) 0%, var(--linkedin-dark-blue) 100%);
        height: 60px;
        position: relative;
    }

    .profile-avatar {
        position: absolute;
        bottom: -30px;
        left: 50%;
        transform: translateX(-50%);
        width: 60px;
        height: 60px;
        border-radius: 50%;
        background: white;
        border: 3px solid white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
        color: var(--linkedin-blue);
        font-weight: 600;
    }

    .profile-info {
        padding: 2rem 1rem 1rem;
        text-align: center;
    }

    .profile-name {
        font-size: 1.25rem;
        font-weight: 600;
        margin-bottom: 0.25rem;
    }

    .profile-title {
        color: var(--linkedin-gray);
        font-size: 0.875rem;
        margin-bottom: 1rem;
    }

    .profile-stats {
        border-top: 1px solid #e0e0e0;
        padding: 1rem;
        display: flex;
        justify-content: space-between;
        text-align: center;
    }

    .stat-item {
        flex: 1;
    }

    .stat-number {
        font-weight: 600;
        color: var(--linkedin-blue);
        display: block;
    }

    .stat-label {
        font-size: 0.75rem;
        color: var(--linkedin-gray);
    }

    .post-card {
        background: white;
        border-radius: 0.75rem;
        border: 1px solid #e0e0e0;
        margin-bottom: 1rem;
    }

    .post-header {
        padding: 1rem;
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }

    .post-avatar {
        width: 48px;
        height: 48px;
        border-radius: 50%;
        background: var(--linkedin-blue);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: 600;
    }

    .post-author {
        flex: 1;
    }

    .post-author-name {
        font-weight: 600;
        margin-bottom: 0.25rem;
    }

    .post-time {
        font-size: 0.875rem;
        color: var(--linkedin-gray);
    }

    .post-content {
        padding: 0 1rem 1rem;
    }

    .post-text {
        margin-bottom: 1rem;
        line-height: 1.6;
    }

    .post-image {
        width: 100%;
        max-height: 400px;
        object-fit: cover;
        border-radius: 0.5rem;
        margin-bottom: 1rem;
    }

    .post-actions {
        padding: 0.75rem 1rem;
        border-top: 1px solid #e0e0e0;
        display: flex;
        gap: 1rem;
    }

    .post-action {
        flex: 1;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
        padding: 0.5rem;
        border-radius: 0.5rem;
        color: var(--linkedin-gray);
        text-decoration: none;
        transition: all 0.2s;
        border: none;
        background: none;
        cursor: pointer;
        position: relative;
    }

    .post-action:hover {
        background-color: var(--linkedin-light-gray);
        color: var(--linkedin-blue);
        text-decoration: none;
    }

    .post-action.active {
        color: var(--linkedin-blue);
        font-weight: 600;
    }

    .create-post {
        background: white;
        border-radius: 0.75rem;
        border: 1px solid #e0e0e0;
        padding: 1rem;
        margin-bottom: 1rem;
    }

    .create-post-header {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        margin-bottom: 1rem;
    }

    .create-post-input {
        border: none;
        outline: none;
        width: 100%;
        padding: 0.75rem;
        border-radius: 0.5rem;
        background-color: var(--linkedin-light-gray);
        resize: none;
    }

    .create-post-input:focus {
        background-color: white;
        box-shadow: 0 0 0 2px var(--linkedin-blue);
    }

    .create-post-actions {
        display: flex;
        gap: 0.5rem;
        justify-content: space-between;
    }

    .post-attachments {
        display: flex;
        gap: 0.5rem;
    }

    .attachment-btn {
        padding: 0.5rem 1rem;
        border: none;
        background: none;
        color: var(--linkedin-gray);
        border-radius: 0.5rem;
        transition: all 0.2s;
        cursor: pointer;
    }

    .attachment-btn:hover {
        background-color: var(--linkedin-light-gray);
        color: var(--linkedin-blue);
    }

    .trending-topics {
        background: white;
        border-radius: 0.75rem;
        border: 1px solid #e0e0e0;
        padding: 1rem;
    }

    .trending-topic {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        padding: 0.75rem 0;
        border-bottom: 1px solid #f0f0f0;
    }

    .trending-topic:last-child {
        border-bottom: none;
    }

    .trending-number {
        font-weight: 600;
        color: var(--linkedin-gray);
        min-width: 20px;
    }

    .trending-text {
        flex: 1;
    }

    .trending-title {
        font-weight: 600;
        margin-bottom: 0.25rem;
    }

    .trending-meta {
        font-size: 0.875rem;
        color: var(--linkedin-gray);
    }

    .post-options {
        position: relative;
    }

    .post-options-btn {
        background: none;
        border: none;
        color: var(--linkedin-gray);
        padding: 0.25rem;
        border-radius: 50%;
        cursor: pointer;
    }

    .post-options-btn:hover {
        background-color: var(--linkedin-light-gray);
    }

    .post-options-menu {
        position: absolute;
        top: 100%;
        right: 0;
        background: white;
        border: 1px solid #e0e0e0;
        border-radius: 0.5rem;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        z-index: 1000;
        min-width: 150px;
        display: none;
    }

    .post-options-menu.show {
        display: block;
    }

    .post-option-item {
        padding: 0.5rem 1rem;
        border: none;
        background: none;
        width: 100%;
        text-align: left;
        cursor: pointer;
        color: var(--linkedin-gray);
    }

    .post-option-item:hover {
        background-color: var(--linkedin-light-gray);
    }

    .post-option-item.delete {
        color: #dc3545;
    }

    .comments-section {
        border-top: 1px solid #e0e0e0;
        padding: 1rem;
        background-color: #f8f9fa;
    }

    .comment-form {
        display: flex;
        gap: 0.5rem;
        margin-bottom: 1rem;
    }

    .comment-input {
        flex: 1;
        border: none;
        outline: none;
        padding: 0.5rem;
        border-radius: 0.5rem;
        background-color: white;
    }

    .comment-item {
        display: flex;
        gap: 0.5rem;
        margin-bottom: 0.5rem;
        padding: 0.5rem;
        background: white;
        border-radius: 0.5rem;
    }

    .comment-avatar {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        background: var(--linkedin-blue);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 0.75rem;
        font-weight: 600;
    }

    .comment-content {
        flex: 1;
    }

    .comment-author {
        font-weight: 600;
        font-size: 0.875rem;
        margin-bottom: 0.25rem;
    }

    .comment-text {
        font-size: 0.875rem;
        line-height: 1.4;
    }

    .comment-time {
        font-size: 0.75rem;
        color: var(--linkedin-gray);
        margin-top: 0.25rem;
    }

    .reactions-count {
        font-size: 0.875rem;
        color: var(--linkedin-gray);
        margin-bottom: 0.5rem;
    }

    .reactions-menu {
        position: absolute;
        bottom: 100%;
        left: 50%;
        transform: translateX(-50%);
        background: white;
        border: 1px solid #e0e0e0;
        border-radius: 0.5rem;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        z-index: 1000;
        padding: 0.5rem;
        margin-bottom: 0.5rem;
        min-width: 280px;
    }

    .reactions-container {
        display: flex;
        gap: 0.5rem;
        justify-content: center;
    }

    .reaction-btn {
        width: 40px;
        height: 40px;
        border: none;
        background: none;
        border-radius: 50%;
        font-size: 1.2rem;
        cursor: pointer;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .reaction-btn:hover {
        background-color: var(--linkedin-light-gray);
        transform: scale(1.1);
    }
</style>
{% endblock %}

{% block content %}
<div class="dashboard-container">
    <div class="container">
        <div class="row">
            <!-- Sidebar gauche -->
            <div class="col-lg-3">
                <div class="sidebar">
                    <!-- Carte profil -->
                    <div class="profile-card">
                        <div class="profile-header">
                            {% if user.profile.cover_picture %}
                                <img src="{{ user.profile.cover_picture.url }}" alt="Photo de couverture" style="width: 100%; height: 100%; object-fit: cover;">
                            {% endif %}
                        </div>
                        <div class="profile-avatar">
                            {% if user.profile.profile_picture %}
                                <img src="{{ user.profile.profile_picture.url }}" alt="Photo de profil" style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%;">
                            {% else %}
                                {{ user.first_name.0 }}{{ user.last_name.0 }}
                            {% endif %}
                        </div>
                        <div class="profile-info">
                            <div class="profile-name">{{ user.first_name }} {{ user.last_name }}</div>
                            <div class="profile-title">Développeur Full Stack</div>
                            <div class="profile-stats">
                                <div class="stat-item">
                                    <span class="stat-number">{{ total_users }}</span>
                                    <span class="stat-label">Utilisateurs</span>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-number">{{ total_posts }}</span>
                                    <span class="stat-label">Posts</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Sujets tendance -->
                    <div class="trending-topics">
                        <h6 class="mb-3 fw-semibold">
                            <i class="fas fa-fire me-2 text-warning"></i>Sujets tendance
                        </h6>
                        {% for topic in trending_topics %}
                        <div class="trending-topic">
                            <div class="trending-number">#{{ forloop.counter }}</div>
                            <div class="trending-text">
                                <div class="trending-title">{{ topic.title }}</div>
                                <div class="trending-meta">{{ topic.count }} posts</div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>

            <!-- Contenu principal -->
            <div class="col-lg-6">
                <!-- Créer un post -->
                <div class="create-post">
                    <form method="post" enctype="multipart/form-data" id="create-post-form">
                        {% csrf_token %}
                        <div class="create-post-header">
                            <div class="post-avatar">
                                {% if user.profile.profile_picture %}
                                    <img src="{{ user.profile.profile_picture.url }}" alt="Photo de profil" style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%;">
                                {% else %}
                                    {{ user.first_name.0 }}{{ user.last_name.0 }}
                                {% endif %}
                            </div>
                            <div class="flex-grow-1">
                                {{ form.content }}
                            </div>
                        </div>
                        <div class="create-post-actions">
                            <div class="post-attachments">
                                <button type="button" class="attachment-btn" onclick="document.getElementById('{{ form.image.id_for_label }}').click()">
                                    <i class="fas fa-image me-2"></i>Photo
                                </button>
                                <button type="button" class="attachment-btn">
                                    <i class="fas fa-video me-2"></i>Vidéo
                                </button>
                                <button type="button" class="attachment-btn">
                                    <i class="fas fa-file me-2"></i>Document
                                </button>
                            </div>
                            {{ form.image }}
                            <button type="submit" class="btn btn-linkedin">
                                <i class="fas fa-paper-plane me-2"></i>Publier
                            </button>
                        </div>

                        <!-- Zone de prévisualisation de l'image -->
                        <div id="image-preview-container" style="display: none;" class="mt-3">
                            <div class="d-flex align-items-center justify-content-between p-3 bg-light rounded">
                                <div class="d-flex align-items-center">
                                    <img id="image-preview" src="" alt="Prévisualisation" style="width: 60px; height: 60px; object-fit: cover; border-radius: 8px; margin-right: 12px;">
                                    <div>
                                        <div id="image-name" class="fw-semibold"></div>
                                        <div id="image-size" class="text-muted small"></div>
                                    </div>
                                </div>
                                <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeImage()">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                    </form>
                </div>

                <!-- Posts -->
                {% for post in page_obj %}
                <div class="post-card" id="post-{{ post.id }}">
                    <div class="post-header">
                        <div class="post-avatar">
                            {% if post.author.profile.profile_picture %}
                                <img src="{{ post.author.profile.profile_picture.url }}" alt="Photo de profil" style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%;">
                            {% else %}
                                {{ post.author.first_name.0 }}{{ post.author.last_name.0 }}
                            {% endif %}
                        </div>
                        <div class="post-author">
                            <div class="post-author-name">{{ post.author.first_name }} {{ post.author.last_name }}</div>
                            <div class="post-time">{{ post.created_at|timesince }} • <i class="fas fa-globe"></i></div>
                        </div>
                        {% if post.author == user %}
                        <div class="post-options">
                            <button class="post-options-btn" onclick="togglePostOptions({{ post.id }})">
                                <i class="fas fa-ellipsis-h"></i>
                            </button>
                            <div class="post-options-menu" id="post-options-{{ post.id }}">
                                <a href="{% url 'posts:edit_post' post.id %}" class="post-option-item">
                                    <i class="fas fa-edit me-2"></i>Modifier
                                </a>
                                <form method="post" action="{% url 'posts:delete_post' post.id %}" style="display: inline;">
                                    {% csrf_token %}
                                    <button type="submit" class="post-option-item delete" onclick="return confirm('Êtes-vous sûr de vouloir supprimer ce post ?')">
                                        <i class="fas fa-trash me-2"></i>Supprimer
                                    </button>
                                </form>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                    <div class="post-content">
                        <div class="post-text">{{ post.content }}</div>
                        {% if post.image %}
                            <img src="{{ post.image.url }}" alt="Image du post" class="post-image">
                        {% endif %}
                    </div>

                    <!-- Réactions -->
                    <div class="reactions-count">
                        {% if post.total_reactions > 0 %}
                            <div class="d-flex align-items-center gap-2 mb-2">
                                {% for stat in post.reactions_stats|slice:":3" %}
                                    <span class="badge bg-light text-dark">
                                        {% if stat.reaction_type == 'LIKE' %}
                                            👍
                                        {% elif stat.reaction_type == 'LOVE' %}
                                            ❤️
                                        {% elif stat.reaction_type == 'FUNNY' %}
                                            😂
                                        {% elif stat.reaction_type == 'WOW' %}
                                            😮
                                        {% elif stat.reaction_type == 'SAD' %}
                                            😢
                                        {% elif stat.reaction_type == 'ANGRY' %}
                                            😠
                                        {% endif %}
                                        {{ stat.count }}
                                    </span>
                                {% endfor %}
                                {% if post.total_reactions > 3 %}
                                    <span class="text-muted">+{{ post.total_reactions|add:"-3" }} autres</span>
                                {% endif %}
                            </div>
                        {% endif %}
                    </div>

                    <div class="post-actions">
                        <div class="position-relative">
                            <button class="post-action {% if post.user_reaction %}active{% endif %}"
                                    onmouseenter="toggleReactionsMenu({{ post.id }})"
                                    onclick="toggleReaction({{ post.id }}, 'LIKE')"
                                    id="like-btn-{{ post.id }}"
                                    data-post-id="{{ post.id }}">
                                {% if post.user_reaction and post.user_reaction.reaction_type == 'LIKE' %}
                                    <i class="fas fa-thumbs-up text-primary"></i>
                                {% else %}
                                    <i class="far fa-thumbs-up"></i>
                                {% endif %}
                                J'aime
                            </button>

                            <!-- Menu des réactions -->
                            <div class="reactions-menu" id="reactions-menu-{{ post.id }}" style="display: none;">
                                <div class="reactions-container">
                                    <button class="reaction-btn" onclick="toggleReaction({{ post.id }}, 'LIKE')" title="J'aime">
                                        👍
                                    </button>
                                    <button class="reaction-btn" onclick="toggleReaction({{ post.id }}, 'LOVE')" title="J'adore">
                                        ❤️
                                    </button>
                                    <button class="reaction-btn" onclick="toggleReaction({{ post.id }}, 'FUNNY')" title="Haha">
                                        😂
                                    </button>
                                    <button class="reaction-btn" onclick="toggleReaction({{ post.id }}, 'WOW')" title="Wow">
                                        😮
                                    </button>
                                    <button class="reaction-btn" onclick="toggleReaction({{ post.id }}, 'SAD')" title="Triste">
                                        😢
                                    </button>
                                    <button class="reaction-btn" onclick="toggleReaction({{ post.id }}, 'ANGRY')" title="En colère">
                                        😠
                                    </button>
                                </div>
                            </div>
                        </div>

                        <button class="post-action" onclick="showComments({{ post.id }})">
                            <i class="far fa-comment"></i>Commenter
                        </button>
                        <button class="post-action">
                            <i class="fas fa-share"></i>Partager
                        </button>
                        <button class="post-action">
                            <i class="far fa-paper-plane"></i>Envoyer
                        </button>
                    </div>

                    <!-- Section commentaires -->
                    <div class="comments-section" id="comments-{{ post.id }}" style="display: none;">
                        <form method="post" action="{% url 'posts:add_comment' post.id %}" class="comment-form">
                            {% csrf_token %}
                            <div class="comment-avatar">
                                {% if user.profile.profile_picture %}
                                    <img src="{{ user.profile.profile_picture.url }}" alt="Photo de profil" style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%;">
                                {% else %}
                                    {{ user.first_name.0 }}{{ user.last_name.0 }}
                                {% endif %}
                            </div>
                            <input type="text" name="content" placeholder="Ajouter un commentaire..." class="comment-input" required>
                            <button type="submit" class="btn btn-sm btn-linkedin">Envoyer</button>
                        </form>

                        {% for comment in post.comments.all %}
                        <div class="comment-item">
                            <div class="comment-avatar">
                                {% if comment.author.profile.profile_picture %}
                                    <img src="{{ comment.author.profile.profile_picture.url }}" alt="Photo de profil" style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%;">
                                {% else %}
                                    {{ comment.author.first_name.0 }}{{ comment.author.last_name.0 }}
                                {% endif %}
                            </div>
                            <div class="comment-content">
                                <div class="comment-author">{{ comment.author.first_name }} {{ comment.author.last_name }}</div>
                                <div class="comment-text">{{ comment.content }}</div>
                                <div class="comment-time">{{ comment.created_at|timesince }}</div>
                            </div>
                            {% if comment.author == user %}
                            <form method="post" action="{% url 'posts:delete_comment' comment.id %}" style="display: inline;">
                                {% csrf_token %}
                                <button type="submit" class="btn btn-sm btn-outline-danger" onclick="return confirm('Supprimer ce commentaire ?')">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </form>
                            {% endif %}
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% empty %}
                <div class="post-card">
                    <div class="post-content text-center py-4">
                        <i class="fas fa-newspaper text-muted fs-1 mb-3"></i>
                        <h5 class="text-muted">Aucun post pour le moment</h5>
                        <p class="text-muted">Soyez le premier à partager quelque chose !</p>
                    </div>
                </div>
                {% endfor %}

                <!-- Pagination -->
                {% if page_obj.has_other_pages %}
                <nav aria-label="Navigation des posts">
                    <ul class="pagination justify-content-center">
                        {% if page_obj.has_previous %}
                            <li class="page-item">
                                <a class="page-link" href="?page={{ page_obj.previous_page_number }}">Précédent</a>
                            </li>
                        {% endif %}

                        {% for num in page_obj.paginator.page_range %}
                            {% if page_obj.number == num %}
                                <li class="page-item active">
                                    <span class="page-link">{{ num }}</span>
                                </li>
                            {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
                                <li class="page-item">
                                    <a class="page-link" href="?page={{ num }}">{{ num }}</a>
                                </li>
                            {% endif %}
                        {% endfor %}

                        {% if page_obj.has_next %}
                            <li class="page-item">
                                <a class="page-link" href="?page={{ page_obj.next_page_number }}">Suivant</a>
                            </li>
                        {% endif %}
                    </ul>
                </nav>
                {% endif %}
            </div>

            <!-- Sidebar droite -->
            <div class="col-lg-3">
                <div class="sidebar">
                    <!-- Suggestions de connexions -->
                    <div class="trending-topics">
                        <h6 class="mb-3 fw-semibold">
                            <i class="fas fa-users me-2 text-primary"></i>Suggestions pour vous
                        </h6>
                        {% for suggested_user in suggested_users %}
                        <div class="trending-topic">
                            <div class="post-avatar" style="width: 40px; height: 40px; font-size: 0.875rem;">
                                {% if suggested_user.profile.profile_picture %}
                                    <img src="{{ suggested_user.profile.profile_picture.url }}" alt="Photo de profil" style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%;">
                                {% else %}
                                    {{ suggested_user.first_name.0 }}{{ suggested_user.last_name.0 }}
                                {% endif %}
                            </div>
                            <div class="trending-text">
                                <div class="trending-title">{{ suggested_user.first_name }} {{ suggested_user.last_name }}</div>
                                <div class="trending-meta">Développeur</div>
                            </div>
                            <button class="btn btn-sm btn-outline-linkedin">+</button>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Gestion des options de post
function togglePostOptions(postId) {
    const menu = document.getElementById(`post-options-${postId}`);
    menu.classList.toggle('show');

    // Fermer les autres menus
    document.querySelectorAll('.post-options-menu').forEach(m => {
        if (m.id !== `post-options-${postId}`) {
            m.classList.remove('show');
        }
    });
}

// Fermer les menus quand on clique ailleurs
document.addEventListener('click', function(e) {
    if (!e.target.closest('.post-options')) {
        document.querySelectorAll('.post-options-menu').forEach(m => {
            m.classList.remove('show');
        });
    }
});

// Gestion des commentaires
function showComments(postId) {
    const commentsSection = document.getElementById(`comments-${postId}`);
    commentsSection.style.display = commentsSection.style.display === 'none' ? 'block' : 'none';
}

// Gestion des réactions
function toggleReaction(postId, reactionType) {
    const formData = new FormData();
    formData.append('reaction_type', reactionType);
    formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);

    fetch(`/reaction/${postId}/`, {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            updateReactionsDisplay(postId, data);
        }
    })
    .catch(error => {
        console.error('Erreur:', error);
    });
}

function updateReactionsDisplay(postId, data) {
    const postElement = document.getElementById(`post-${postId}`);
    const reactionsCountElement = postElement.querySelector('.reactions-count');
    const likeBtn = document.getElementById(`like-btn-${postId}`);

    // Mettre à jour le bouton principal
    if (data.user_reaction) {
        likeBtn.classList.add('active');
        const icon = likeBtn.querySelector('i');
        icon.className = 'fas fa-thumbs-up text-primary';
    } else {
        likeBtn.classList.remove('active');
        const icon = likeBtn.querySelector('i');
        icon.className = 'far fa-thumbs-up';
    }

    // Mettre à jour l'affichage des réactions
    if (data.total_reactions > 0) {
        let reactionsHtml = '<div class="d-flex align-items-center gap-2 mb-2">';
        data.reactions_stats.slice(0, 3).forEach(stat => {
            const emoji = getReactionEmoji(stat.reaction_type);
            reactionsHtml += `<span class="badge bg-light text-dark">${emoji} ${stat.count}</span>`;
        });
        if (data.total_reactions > 3) {
            reactionsHtml += `<span class="text-muted">+${data.total_reactions - 3} autres</span>`;
        }
        reactionsHtml += '</div>';
        reactionsCountElement.innerHTML = reactionsHtml;
    } else {
        reactionsCountElement.innerHTML = '';
    }
}

function getReactionEmoji(reactionType) {
    const emojis = {
        'LIKE': '👍',
        'LOVE': '❤️',
        'FUNNY': '😂',
        'WOW': '😮',
        'SAD': '😢',
        'ANGRY': '😠'
    };
    return emojis[reactionType] || '👍';
}

// Afficher/masquer le menu des réactions
function toggleReactionsMenu(postId) {
    const menu = document.getElementById(`reactions-menu-${postId}`);
    const isVisible = menu.style.display === 'block';

    // Masquer tous les menus
    document.querySelectorAll('.reactions-menu').forEach(m => {
        m.style.display = 'none';
    });

    // Afficher le menu si il n'était pas visible
    if (!isVisible) {
        menu.style.display = 'block';
    }
}

// Masquer les menus quand on clique ailleurs
document.addEventListener('click', function(e) {
    if (!e.target.closest('.post-action')) {
        document.querySelectorAll('.reactions-menu').forEach(m => {
            m.style.display = 'none';
        });
    }
});

// Prévisualisation de l'image
document.getElementById('{{ form.image.id_for_label }}').addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (file) {
        // Validation du type de fichier
        if (!file.type.startsWith('image/')) {
            alert('Veuillez sélectionner un fichier image valide.');
            this.value = '';
            return;
        }

        // Validation de la taille (max 5MB)
        const maxSize = 5 * 1024 * 1024; // 5MB
        if (file.size > maxSize) {
            alert('L\'image est trop volumineuse. Taille maximum : 5MB');
            this.value = '';
            return;
        }

        const reader = new FileReader();
        reader.onload = function(e) {
            document.getElementById('image-preview').src = e.target.result;
            document.getElementById('image-preview-container').style.display = 'block';
            document.getElementById('image-name').textContent = file.name;
            document.getElementById('image-size').textContent = formatFileSize(file.size);
        };
        reader.onerror = function() {
            alert('Erreur lors de la lecture du fichier.');
            document.getElementById('{{ form.image.id_for_label }}').value = '';
        };
        reader.readAsDataURL(file);
    } else {
        document.getElementById('image-preview-container').style.display = 'none';
    }
});

// Fonction pour formater la taille du fichier
function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

// Supprimer la prévisualisation
function removeImage() {
    document.getElementById('{{ form.image.id_for_label }}').value = ''; // Effacer le champ de fichier
    document.getElementById('image-preview').src = ''; // Effacer l'image de prévisualisation
    document.getElementById('image-preview-container').style.display = 'none'; // Masquer le conteneur
    document.getElementById('image-name').textContent = ''; // Effacer le nom de fichier
    document.getElementById('image-size').textContent = ''; // Effacer la taille
}
</script>
{% endblock %}
